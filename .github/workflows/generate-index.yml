name: Generate asset indexes

on:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json for images & personages folders
        shell: bash
        run: |
          set -e
          echo "Generating index.json files..."

          gen_index () {
            folder_name="$1"   # images of personages
            exts_regex="$2"    # bv. '\.(jpg|png)$'

            find . -type d -name "$folder_name" | while read -r dir; do
              echo "Processing $dir"

              files=$(ls -1 "$dir" 2>/dev/null \
                | grep -E "$exts_regex" \
                | sort \
                | sed 's/^/"/;s/$/"/' \
                | paste -sd "," -)

              if [ -z "$files" ]; then
                echo '{ "files": [] }' > "$dir/index.json"
              else
                echo "{ \"files\": [ $files ] }" > "$dir/index.json"
              fi
            done
          }

          # images: typische fotoformaten
          gen_index "images" '\.(jpg|jpeg|png|webp)$'

          # personages: vaak png/webp, maar laat jpg ook toe (sepia avatars etc.)
          gen_index "personages" '\.(png|webp|jpg|jpeg)$'

      - name: Commit & push changes (if any)
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          find . -name index.json -print0 | xargs -0 git add

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto-generate asset index.json"
          git push
